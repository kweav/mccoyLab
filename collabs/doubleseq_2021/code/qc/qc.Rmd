---
title: "qc"
author: "Kate Weaver"
date: "12/20/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(SummarizedExperiment)
```

```{r}
load("~/mccoyLab/collabs/doubleseq_2021/summarized_experiment/create_summarized_experiment_allNov2021.Rdata")
```

```{r}
counts <- as.matrix(assays(seAll)$counts)
```

```{r, message=FALSE}
library(rtracklayer)
library(tidyverse)

gtf <- rtracklayer::import("~/genomes/hg38_genome/gencode.v34.annotation.gtf") %>%
  as.data.frame() %>% 
  filter(type == "gene") %>% 
  select(gene_id, seqnames) %>% 
  dplyr::rename(ensembl_gene_id = gene_id) %>% 
  dplyr::rename(chromosome_name = seqnames)

gene_table <- gtf[match(rownames(counts), gtf$ensembl_gene_id),]
gene_table <- gene_table[gene_table$chromosome_name %in% paste0("chr", 1:22),]

counts_genes <- counts[gene_table$ensembl_gene_id,]
```

```{r}
dim(counts)
dim(counts_genes)
```

```{r}
gene_sum = colSums(counts_genes > 0)
length(gene_sum)
mean(gene_sum)
sd(gene_sum)
```

```{r}
library(ggplot2)
gene_df <- data.frame(sumgenes = gene_sum)
ggplot(gene_df, aes(x=NULL, y=sumgenes)) + geom_boxplot() + ylab("Number of genes with\nread counts >0 within sample") + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank()) + xlab("") + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```

```{r}
sample_sum = rowSums(counts_genes > 0)
length(sample_sum)
mean(sample_sum)
sd(sample_sum)
```

```{r}
sample_df <- data.frame(sumsample = sample_sum)
ggplot(sample_df, aes(x=NULL, y=sumsample)) + geom_boxplot() + ylab("Number of samples with\nread counts >0 within genes") + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank()) + xlab("") + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```
```{r}
samples <- read.delim("~/mccoyLab/collabs/doubleseq_2021/summarized_experiment/qc_files/sample_allNov2021.txt", sep=".", col.names = c("sample", "description1", "description2")) %>% dplyr::select("sample") %>% mutate(sample = gsub("Log", '', sample))
uniq_read_num <- read.delim("~/mccoyLab/collabs/doubleseq_2021/summarized_experiment/qc_files/uniq_reads_num_allNov2021.txt", sep="|", col.names =c("description", "num")) %>% dplyr::select("num")
uniq_read_per <- read.delim("~/mccoyLab/collabs/doubleseq_2021/summarized_experiment/qc_files/uniq_reads_percent_allNov2021.txt", sep="|", col.names=c("description", "percent")) %>% dplyr::select("percent") %>% mutate(percent = as.numeric(gsub('%', '', percent)))

uniq_read_df <- data.frame(sample = samples, num = uniq_read_num, percent = uniq_read_per)
two_samples <- uniq_read_df %>% dplyr::arrange(percent)
two_samples <- two_samples[c(1:2),]
two_samples$sample
```

```{r}
ggplot(uniq_read_df, aes(x=NULL, y=num)) + geom_boxplot() + ylab("Number of uniquely mapped reads per sample") + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank()) + xlab("") + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```
```{r}
ggplot(uniq_read_df, aes(x=NULL, y=percent)) + geom_boxplot() + ylab("Percent of uniquely mapped reads per sample") + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank()) + xlab("") + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```
```{r}
shapiro.test(uniq_read_df$percent)
ggplot(uniq_read_df, aes(sample=percent)) + geom_qq() + geom_qq_line() + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank()) + xlab("Theoretical Quantiles") + ylab("Observed Quantiles")
ggplot(uniq_read_df, aes(x=percent)) + geom_histogram() + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank()) + xlab("Percent")
```

```{r, message=FALSE}
library(EnvStats)
```

```{r}
rosnerTest(uniq_read_df$percent, k=3, warn=TRUE)
```

```{r}
mean(uniq_read_df$percent) + (2 * sd(uniq_read_df$percent))
mean(uniq_read_df$percent) - (2 * sd(uniq_read_df$percent))
mean(uniq_read_df$percent) - (3 * sd(uniq_read_df$percent))
mean(uniq_read_df$percent) - (4 * sd(uniq_read_df$percent))
```

```{r}
shapiro.test(uniq_read_df$num)
ggplot(uniq_read_df, aes(sample=num)) + geom_qq() + geom_qq_line() + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank()) + xlab("Theoretical Quantiles") + ylab("Observed Quantiles")
ggplot(uniq_read_df, aes(x=num)) + geom_histogram() + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank()) + xlab("Number")
```


```{r}
rosnerTest(uniq_read_df$num, k=3, warn=TRUE)
```

```{r}
mean(uniq_read_df$num) + (2 * sd(uniq_read_df$num))
mean(uniq_read_df$num) - (2 * sd(uniq_read_df$num))
mean(uniq_read_df$num) - (3 * sd(uniq_read_df$num))
mean(uniq_read_df$num) - (4 * sd(uniq_read_df$num))
```
